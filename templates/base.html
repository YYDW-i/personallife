<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{% block title %}LocalLife{% endblock %}</title>
  {%load static%}
  <link rel="stylesheet" href="{% static 'css/app.css' %}">
</head>
<body>
  <div class="wrap">
    <header class="glass header">
      <div>
        <div class="brand">LocalLife</div>
        <div class="slogan">本地优先 · 隐私友好 · 精致生活控制台</div>
      </div>
      <div class="badge">可运行</div>
    </header>

    <nav class="glass tabs">
      {% if user.is_authenticated %}
        {% url 'core:dashboard' as dash_url %}
        {% url 'tasks:index' as tasks_url %}
        {% url 'maths:home' as maths_url %}
        {% url 'planner:index' as cal_url %}
        {% url 'news:index' as news_url %}
        {% url 'analytics_app:iching_index' as analytics_app_url %}
        {% url 'profiles:settings' as set_url %}
        <div class="tabs-left">
          <a class="tab {% if request.path == dash_url %}active{% endif %}" href="{{ dash_url }}">Dashboard</a>
          <a class="tab {% if request.path|slice:":7" == "/tasks/" %}active{% endif %}" href="{{ tasks_url }}">Tasks</a>
          <a class="tab {% if request.path|slice:":8" == "/maths/" %}active{% endif %}" href="{{ maths_url }}">Maths</a>
          <a class="tab {% if request.path|slice:":10" == "/calendar/" %}active{% endif %}" href="{{ cal_url }}">Calendar</a>
          <a class="tab {% if request.path|slice:":7" == "/news/" %}active{% endif %}" href="{{ news_url }}">News</a>
          <a class="tab {% if request.path|slice:":20" == "/analytics/iching/" %}active{% endif %}" href="{{ analytics_app_url }}">Analytics</a>
          <a class="tab {% if request.path|slice:":10" == "/settings/" %}active{% endif %}" href="{{ set_url }}">Settings</a>
        </div>

        <div class="tabs-right">
        <span class="tab subtle">你好，{{ user.username }}</span>
        <form method="post" action="{% url 'logout' %}" style="display:inline;">
          {% csrf_token %}
          <button type="submit" class="tab subtle" style="background:transparent;border:0;cursor:pointer;">
            退出
          </button>
        </form>
      </div>
      {% else %}
        <div class="tabs-left">
          <a class="tab subtle">未登录</a>
        </div>
      {% endif %}

    </nav>

    <main>
      {% block content %}{% endblock %}
    </main>
  </div>
  <script>
  (function() {
      // 如果当前已经是专注页，则不再轮询，防止循环跳转
      if (window.location.pathname.startsWith('/tasks/focus/')) {
          return;
      }

      const CHECK_INTERVAL = 5000; // 5秒检查一次
      const endpoint = "{% url 'tasks:active_focus_api' %}";

      async function checkFocus() {
          try {
              const resp = await fetch(endpoint, { credentials: 'same-origin' });
              const data = await resp.json();
              if (data.active && data.focus_url) {
                  // 发现专注任务，立即跳转
                  window.location.href = data.focus_url;
              }
          } catch (e) {
              console.warn('专注状态检查失败', e);
          }
      }

      // 立即执行一次，然后定时检查
      checkFocus();
      setInterval(checkFocus, CHECK_INTERVAL);
  })();
  </script>
</body>
</html>
