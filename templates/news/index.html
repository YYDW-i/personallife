{% extends "base.html" %}
{% block title %}News · LocalLife{% endblock %}

{% block content %}
<section class="glass card">
  <div class="cal-head">
    <div>
      <div class="card-title">News · 每日简报</div>
      <div class="card-subtitle">{{ date }} · 标题 + 2–4 句高密度摘要 + 原文链接</div>
    </div>
    <div class="cal-actions">
      <a class="btn subtle" href="{% url 'news:preferences' %}">偏好设置</a>
      <form method="POST" action="{% url 'news:refresh_today' %}" id="refresh-form">
        {% csrf_token %}
        <button type="submit" class="btn">刷新今日简报</button>
      </form>
    </div>
  </div>
  <!-- 加载遮罩，默认隐藏 -->
  <div id="loading-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; justify-content:center; align-items:center; flex-direction:column; color:white;">
      <div style="width:300px; background:#333; border-radius:10px; overflow:hidden;">
          <div id="progress-bar" style="width:0%; height:20px; background:#4caf50; transition:width 0.2s;"></div>
      </div>
      <div style="margin-top:10px;">正在刷新新闻 <span id="progress-percent">0%</span></div>
      <div style="margin-top:5px; font-size:14px; opacity:0.8;">请稍候...</div>
  </div>

  <style>
  .spinner {
      border: 4px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top: 4px solid #fff;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
  }
  @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
  }
  </style>
  {% if not brief %}
    <div class="muted" style="margin-top:14px;">
      还没有生成今日简报。你可以点击“刷新今日简报”，或等待系统每日自动生成。
    </div>
  {% else %}
    <div style="display:flex; flex-direction:column; gap:12px; margin-top:14px;">
      {% for e in brief.entries.all %}
        <div class="glass" style="padding:14px; border-radius:16px;">
          <div style="font-weight:700; margin-bottom:6px;">{{ e.title }}</div>
          <div class="muted" style="line-height:1.7;">{{ e.summary}}</div>
          <div style="margin-top:8px; display:flex; gap:10px; align-items:center;">
            <span class="muted" style="font-size:12px;">来源：{{ e.source_name }}</span>
            <a class="btn subtle" href="{{ e.url }}" target="_blank" rel="noreferrer">打开原文</a>
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}
</section>
<script>
(function() {
    const form = document.getElementById('refresh-form');
    if (!form) return;

    const overlay = document.getElementById('loading-overlay');
    const progressBar = document.getElementById('progress-bar');
    const percentText = document.getElementById('progress-percent');
    let progressInterval = null;
    let currentProgress = 0;

    // 开始进度条动画
    function startProgress() {
        currentProgress = 0;
        progressBar.style.width = '0%';
        percentText.textContent = '0%';
        overlay.style.display = 'flex';

        // 模拟进度增长，每100ms增加1%，到90%后停止
        progressInterval = setInterval(() => {
            if (currentProgress < 90) {
                currentProgress += 1;
                progressBar.style.width = currentProgress + '%';
                percentText.textContent = currentProgress + '%';
            } else {
                // 达到90%后暂停增长
                clearInterval(progressInterval);
                progressInterval = null;
            }
        }, 1000);
    }

    // 结束进度条（成功或失败）
    function finishProgress(success = true) {
        if (progressInterval) {
            clearInterval(progressInterval);
            progressInterval = null;
        }
        // 瞬间完成到100%
        currentProgress = 100;
        progressBar.style.width = '100%';
        percentText.textContent = '100%';

        if (success) {
            // 稍后刷新页面
            setTimeout(() => {
                window.location.reload();
            }, 300);
        } else {
            // 失败时短暂显示后隐藏遮罩
            setTimeout(() => {
                overlay.style.display = 'none';
                // 重置进度条以备下次使用
                progressBar.style.width = '0%';
                percentText.textContent = '0%';
            }, 1000);
        }
    }

    form.addEventListener('submit', async (e) => {
        e.preventDefault(); // 阻止默认提交

        // 开始进度条
        startProgress();

        const formData = new FormData(form);
        try {
            const response = await fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                },
                credentials: 'same-origin'
            });
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    finishProgress(true); // 成功，刷新页面
                } else {
                    alert('刷新失败，请稍后重试');
                    finishProgress(false);
                }
            } else {
                alert('网络错误');
                finishProgress(false);
            }
        } catch (err) {
            console.error(err);
            alert('发生错误');
            finishProgress(false);
        }
    });
})();
</script>
{% endblock %}